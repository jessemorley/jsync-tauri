name: Test Signing Keys

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-signing:
    name: Test Signing Configuration
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Verify signing key is set
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          echo "Checking if TAURI_SIGNING_PRIVATE_KEY is set..."
          if [ -z "$TAURI_SIGNING_PRIVATE_KEY" ]; then
            echo "❌ TAURI_SIGNING_PRIVATE_KEY is NOT set!"
            exit 1
          fi
          echo "✅ TAURI_SIGNING_PRIVATE_KEY is set"
          echo "Key length: ${#TAURI_SIGNING_PRIVATE_KEY} characters"
          echo "Key starts with: ${TAURI_SIGNING_PRIVATE_KEY:0:40}..."
          echo ""
          echo "=== FULL KEY (with line breaks visible as [LF]) ==="
          echo "$TAURI_SIGNING_PRIVATE_KEY" | sed 's/$/[LF]/'
          echo "=== END OF KEY ==="
          echo ""
          echo "Using od to show all characters including newlines:"
          echo "$TAURI_SIGNING_PRIVATE_KEY" | od -An -tx1 | head -10

      - name: Test key format and decoding
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          echo "Testing if key can be decoded..."

          # Save key to temp file
          echo "$TAURI_SIGNING_PRIVATE_KEY" > /tmp/test-key.key

          echo "Key file size: $(wc -c < /tmp/test-key.key) bytes"
          echo "Key starts with: $(head -c 50 /tmp/test-key.key)"
          echo ""

          # Try to decode the base64 to see if it's valid
          if echo "$TAURI_SIGNING_PRIVATE_KEY" | base64 -d > /dev/null 2>&1; then
            echo "✅ Key is valid base64"
          else
            echo "❌ Key is NOT valid base64!"
            exit 1
          fi

          # Check for common issues
          if echo "$TAURI_SIGNING_PRIVATE_KEY" | grep -q $'\n'; then
            echo "❌ Key contains line breaks!"
            exit 1
          fi

          if [ "${TAURI_SIGNING_PRIVATE_KEY:0:1}" = " " ] || [ "${TAURI_SIGNING_PRIVATE_KEY: -1}" = " " ]; then
            echo "❌ Key has leading or trailing spaces!"
            exit 1
          fi

          echo "✅ Key format looks good"

      - name: Quick signing test with minimal file
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          echo "Creating a test file to sign..."
          echo "test content" > test-file.txt

          # Try to use the Tauri signer to sign this file
          # This will fail quickly if the key is wrong, without needing to build
          npx @tauri-apps/cli signer sign test-file.txt 2>&1 | tee sign-test.log || true

          if grep -i "failed to decode secret key" sign-test.log; then
            echo ""
            echo "❌ KEY DECODING FAILED!"
            echo "The error suggests the key format or password is wrong"
            echo ""
            cat sign-test.log
            exit 1
          fi

          if grep -i "password" sign-test.log; then
            echo ""
            echo "⚠️  Password-related message detected:"
            cat sign-test.log
            echo ""
            echo "The key might be password-protected even though it was generated without one."
            echo "Try setting TAURI_SIGNING_PRIVATE_KEY_PASSWORD to an empty string in GitHub Secrets"
            exit 1
          fi

          echo "✅ Signing test completed (check for .sig file)"
          ls -la test-file.txt* || true
